<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Us</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        script: ['Dancing Script', 'cursive'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'heartbeat': 'heartbeat 1.5s ease-in-out infinite both',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        heartbeat: {
                            '0%': { transform: 'scale(1)' },
                            '15%': { transform: 'scale(1.3)' },
                            '30%': { transform: 'scale(1)' },
                            '45%': { transform: 'scale(1.15)' },
                            '60%': { transform: 'scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.8)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)', maxHeight: '0' },
                            '100%': { opacity: '1', transform: 'translateY(0)', maxHeight: '500px' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            color: #1d1d1f;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Mesh Gradient Background */
        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-color: #ffdde1;
            overflow: hidden;
        }
        .mesh-blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.8;
            animation: blob 10s infinite alternate;
            border-radius: 50%;
        }
        .mesh-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #ee7752; animation-delay: 0s; }
        .mesh-2 { top: 20%; right: -10%; width: 60vw; height: 60vw; background: #e73c7e; animation-delay: 2s; }
        .mesh-3 { bottom: -10%; left: 10%; width: 50vw; height: 50vw; background: #23a6d5; animation-delay: 4s; }
        .mesh-4 { bottom: 20%; right: 20%; width: 40vw; height: 40vw; background: #23d5ab; animation-delay: 6s; }

        /* Ultra Glass Morphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.6);
        }

        .toggle-checkbox:checked { right: 0; border-color: #34C759; }
        .toggle-checkbox:checked + .toggle-label { background-color: #34C759; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; } 
        
        .note-bubble {
            position: relative;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 14px 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.6);
            max-width: 260px;
        }
    </style>
</head>
<body class="antialiased min-h-screen relative overflow-x-hidden pb-10">

    <!-- Background -->
    <div class="mesh-bg">
        <div class="mesh-blob mesh-1"></div>
        <div class="mesh-blob mesh-2"></div>
        <div class="mesh-blob mesh-3"></div>
        <div class="mesh-blob mesh-4"></div>
    </div>

    <!-- 1. LOADING SCREEN -->
    <div id="loadingScreen" class="fixed inset-0 z-[100] bg-white/40 backdrop-blur-xl flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="relative flex items-center justify-center gap-4">
            <i class="fas fa-heart text-6xl text-pink-500 drop-shadow-lg animate-heartbeat" style="animation-delay: 0s;"></i>
            <i class="fas fa-heart text-6xl text-blue-500 drop-shadow-lg animate-heartbeat" style="animation-delay: 0.2s;"></i>
        </div>
        <p class="mt-6 text-slate-700 font-bold tracking-widest text-sm uppercase animate-pulse drop-shadow-md">Connecting...</p>
    </div>

    <!-- 2. LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 z-[90] flex flex-col items-center justify-center p-6 hidden animate-fade-in">
        <div class="w-full max-w-sm glass-panel rounded-[2rem] p-8 text-center relative overflow-hidden">
            <h1 class="text-4xl font-bold font-script text-slate-800 mb-2">Welcome Back</h1>
            
            <p class="text-slate-600 text-[10px] uppercase tracking-widest font-bold mt-2">Together For</p>
            <div id="loginCountdownContainer" class="flex flex-wrap justify-center gap-2 mb-8 mt-2 min-h-[40px] font-mono font-bold text-slate-700 relative z-10">
                <span class="text-xs text-slate-500">Loading...</span>
            </div>

            <p class="text-slate-600 text-xs uppercase tracking-widest mb-6 font-bold border-t border-slate-300/50 pt-4">Select Profile</p>
            
            <div id="profileSelection" class="grid grid-cols-2 gap-4 mb-2 relative z-10">
                <button onclick="window.selectProfile('Megha')" id="btnMegha" class="p-4 rounded-2xl bg-white/40 border border-white/60 hover:bg-white/60 transition-all group flex flex-col items-center gap-3 shadow-sm hover:shadow-md active:scale-95 duration-200 cursor-pointer">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-pink-300 to-pink-500 text-white flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-heart"></i>
                    </div>
                    <span class="font-bold text-slate-700">Megha</span>
                </button>
                <button onclick="window.selectProfile('Sahariar')" id="btnSahariar" class="p-4 rounded-2xl bg-white/40 border border-white/60 hover:bg-white/60 transition-all group flex flex-col items-center gap-3 shadow-sm hover:shadow-md active:scale-95 duration-200 cursor-pointer">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-300 to-blue-500 text-white flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform">
                        <i class="fas fa-heart"></i>
                    </div>
                    <span class="font-bold text-slate-700">Sahariar</span>
                </button>
            </div>

            <div id="passwordSection" class="hidden space-y-4 animate-fade-in relative z-10 mt-4">
                <div class="relative">
                    <input type="password" id="loginPassword" class="w-full bg-white/50 border border-white/60 rounded-2xl px-4 py-4 pr-12 outline-none text-slate-800 placeholder-slate-500 focus:bg-white/80 transition-all text-center tracking-widest" placeholder="Enter Password">
                    <button onclick="window.togglePasswordVisibility()" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-800 focus:outline-none">
                        <i class="fas fa-eye" id="passwordIcon"></i>
                    </button>
                </div>
                <p id="loginError" class="text-red-500 text-xs mt-2 hidden text-center font-bold bg-red-100/50 py-1 rounded-lg"><i class="fas fa-exclamation-circle"></i> Incorrect</p>
                
                <div class="flex items-center justify-center gap-2">
                    <input type="checkbox" id="rememberMe" class="rounded text-pink-500 focus:ring-pink-500 border-gray-400 w-4 h-4">
                    <label for="rememberMe" class="text-xs font-bold text-slate-600">Keep me logged in</label>
                </div>

                <div class="flex gap-3 mt-4">
                    <button onclick="window.backToProfiles()" class="flex-1 py-3 rounded-xl font-bold text-slate-600 bg-white/40 hover:bg-white/60 transition-colors">Back</button>
                    <button onclick="window.attemptLogin()" class="flex-1 py-3 rounded-xl font-bold text-white bg-slate-900/90 hover:bg-slate-800 shadow-lg active:scale-95 transition-all">Enter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN DASHBOARD -->
    <div id="mainContent" class="hidden min-h-screen flex flex-col">

        <!-- Glass Header -->
        <header class="sticky top-0 z-40 glass-panel border-b-0 rounded-b-3xl mx-2 mt-2 px-6 py-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div id="syncStatus" class="w-2.5 h-2.5 rounded-full bg-slate-300 shadow-inner"></div>
                <h1 class="text-2xl font-bold font-script text-slate-800">Us</h1>
            </div>
            <div class="flex items-center gap-3">
                <span id="headerProfileName" class="text-xs font-bold text-slate-600 uppercase tracking-wider hidden sm:block mr-2 bg-white/30 px-2 py-1 rounded-lg"></span>
                <button onclick="window.logout()" class="text-[10px] font-black text-slate-500 hover:text-red-500 transition-colors tracking-widest uppercase cursor-pointer">Logout</button>
                <!-- Settings Button -->
                <button onclick="window.openSettingsModal()" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center text-slate-600 hover:text-slate-900 transition shadow-sm border border-white/50 cursor-pointer">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <main class="flex-grow max-w-md mx-auto w-full p-4 space-y-6 pb-24">

            <!-- PARTNER OVERVIEW -->
            <div class="animate-fade-in mt-4 relative z-10">
                <div class="flex items-start justify-center gap-6">
                    <!-- Avatar -->
                    <div class="relative group">
                        <div id="partnerAvatarBg" class="w-24 h-24 rounded-full flex items-center justify-center text-4xl shadow-xl border-4 border-white/80 relative z-10 transition-transform duration-500 group-hover:scale-105 backdrop-blur-md">
                            <i class="fas fa-heart text-white drop-shadow-md"></i>
                        </div>
                        <div id="partnerStatusDot" class="absolute bottom-1 right-1 w-6 h-6 rounded-full border-4 border-white/80 z-20 shadow-md"></div>
                        <div id="partnerMoodBadge" class="absolute -top-2 -right-2 w-10 h-10 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-xl shadow-lg border border-white z-20 animate-float">üòä</div>
                    </div>

                    <!-- Note Bubble -->
                    <div class="note-bubble flex-1 animate-pop-in origin-left glass-panel">
                        <div class="flex justify-between items-start mb-2">
                            <span id="partnerNameDisplay" class="text-sm font-bold text-slate-800">Partner</span>
                            <span id="partnerTimeDisplay" class="text-[10px] text-slate-500 font-mono bg-white/50 px-2 py-0.5 rounded-full">00:00:00</span>
                        </div>
                        <p id="partnerNoteText" class="text-sm text-slate-700 leading-snug font-medium">Thinking of you...</p>
                        
                        <div class="flex justify-between items-center mt-3">
                            <div id="partnerWorkBadge" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase shadow-sm">Loading...</div>
                            <span id="partnerLastActive" class="text-[9px] text-slate-500 font-bold ml-2 bg-white/30 px-2 py-0.5 rounded"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MY OVERVIEW (Mirror) -->
            <div class="flex items-start gap-4 justify-center flex-row-reverse animate-fade-in" style="animation-delay: 0.1s;">
                <div class="relative group flex-shrink-0">
                    <div id="myAvatarBg" class="w-20 h-20 rounded-full flex items-center justify-center text-3xl shadow-xl border-4 border-white/80 relative z-10 transition-transform duration-500 group-hover:scale-105 backdrop-blur-md">
                        <i class="fas fa-heart text-white drop-shadow-md"></i>
                    </div>
                    <div id="myStatusDot" class="absolute bottom-1 right-1 w-5 h-5 rounded-full border-2 border-white z-20 shadow-md"></div>
                    <div id="myMoodBadge" class="absolute -top-1 -right-1 w-8 h-8 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-lg shadow-lg border border-white z-20 animate-float">üòä</div>
                </div>
                <div class="note-bubble flex-1">
                    <div class="flex justify-between items-start mb-1">
                        <span id="myNameDisplay" class="text-xs font-bold text-slate-800">Me</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">My Status</span>
                    </div>
                    <p id="myNoteDisplay" class="text-xs text-slate-700 leading-snug font-medium italic mb-2">My note goes here...</p>
                    <div class="flex justify-between items-center border-t border-slate-200/50 pt-2">
                        <div id="myWorkBadge" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold uppercase shadow-sm">Loading...</div>
                        <button onclick="window.toggleMyControls()" class="text-[10px] font-bold text-slate-600 bg-white/60 hover:bg-white px-3 py-1 rounded-full transition-colors flex items-center gap-1 cursor-pointer">
                            <i class="fas fa-pen"></i> Update
                        </button>
                    </div>
                </div>
            </div>

            <!-- MY CONTROLS PANEL (Hidden) -->
            <div id="myControlsPanel" class="hidden glass-panel rounded-[2rem] p-6 shadow-xl animate-slide-down relative z-20 border border-white/70">
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-sm font-bold text-slate-600 uppercase tracking-widest">Update Profile</h2>
                    <div id="mySaveStatus" class="text-[9px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full opacity-0 transition-opacity">SAVED</div>
                </div>

                <!-- Status Toggle -->
                <div class="flex items-center justify-between mb-4 bg-white/40 p-3 rounded-xl border border-white/50">
                    <span class="text-xs font-bold text-slate-700 flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-white/60 flex items-center justify-center text-slate-500"><i class="fas fa-briefcase text-[10px]"></i></div>
                        Working now?
                    </span>
                    <div class="relative inline-block w-10 h-6 align-middle select-none">
                        <input type="checkbox" id="myStatusToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 border-slate-200 appearance-none cursor-pointer transition-all duration-300 shadow-sm" onclick="window.updateMyStatus()"/>
                        <label for="myStatusToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300/50 cursor-pointer transition-colors duration-300"></label>
                    </div>
                </div>

                <!-- Mood Selector -->
                <div class="mb-4 relative">
                    <button onclick="window.toggleMyMoodDropdown()" id="myMoodTrigger" class="w-full bg-white/40 border border-white/50 rounded-xl p-3 flex items-center justify-between hover:bg-white/60 transition-all shadow-sm active:scale-[0.98] cursor-pointer">
                        <span class="flex items-center gap-3">
                            <span id="myControlMoodIcon" class="text-xl filter drop-shadow-sm">üòä</span>
                            <span id="myControlMoodLabel" class="text-xs font-bold text-slate-800">Happy</span>
                        </span>
                        <i class="fas fa-chevron-down text-slate-400 text-[10px]"></i>
                    </button>
                    <div id="myMoodDropdown" class="hidden absolute top-full left-0 w-full mt-2 glass-panel rounded-xl shadow-2xl overflow-hidden z-50 max-h-48 overflow-y-auto">
                        <!-- JS Populates -->
                    </div>
                </div>

                <!-- Note Input -->
                <div class="relative">
                    <textarea id="myNoteInput" readonly class="w-full glass-input rounded-xl p-4 text-xs text-slate-800 placeholder-slate-500 resize-none h-20 outline-none transition-shadow font-medium leading-relaxed opacity-70" placeholder="Share your thoughts..."></textarea>
                    <button onclick="window.toggleNoteEdit()" class="absolute bottom-3 right-3 text-slate-500 hover:text-slate-800 transition-colors p-1.5 bg-white/50 rounded-full shadow-sm hover:shadow-md cursor-pointer">
                        <i id="noteEditIcon" class="fas fa-pen text-[10px]"></i>
                    </button>
                </div>
            </div>

            <!-- SHARED CARD -->
            <div class="glass-panel rounded-[2rem] p-6 shadow-lg text-center animate-fade-in relative z-10" style="animation-delay: 0.1s;">
                <h3 class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Next Meeting</h3>
                
                <div id="countdownContainer" class="flex flex-wrap justify-center gap-2 mb-4">
                    <!-- Timer -->
                </div>
                
                <div class="text-xs text-slate-600 font-bold mb-6 bg-white/30 inline-block px-3 py-1 rounded-full" id="nextMeetDateDisplay">Loading...</div>

                <div class="border-t border-slate-200/50 pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Bucket List</span>
                        <button onclick="window.openBucketModal()" class="w-6 h-6 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-slate-700 transition-colors shadow-lg active:scale-90 cursor-pointer"><i class="fas fa-plus text-[9px]"></i></button>
                    </div>
                    <ul id="bucketList" class="text-left space-y-2">
                        <!-- Items -->
                    </ul>
                </div>
            </div>

            <div class="text-center">
                <p id="togetherTimer" class="text-xs font-mono text-slate-600/80 font-bold drop-shadow-sm mb-4">Loading history...</p>
            </div>

        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-md transition-opacity duration-300" onclick="window.closeSettingsModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xs glass-panel rounded-3xl p-6 shadow-2xl scale-95 opacity-0 transition-all duration-300" id="settingsPanel">
            <h3 class="text-xl font-bold text-slate-800 mb-6 font-script">Settings</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Next Meeting</label>
                    <input type="datetime-local" id="inputNextMeet" class="w-full bg-white/50 border border-white/60 rounded-xl px-4 py-3 text-sm outline-none focus:bg-white/80 transition-colors">
                </div>
                <button onclick="window.saveSettings()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl hover:bg-slate-700 shadow-lg active:scale-95 transition-all">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- BUCKET MODAL -->
    <div id="bucketModal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-md transition-opacity duration-300" onclick="window.closeBucketModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xs glass-panel rounded-3xl p-6 shadow-2xl scale-95 opacity-0 transition-all duration-300" id="bucketPanel">
            <h3 class="text-xl font-bold text-slate-800 mb-6 font-script">Add Goal</h3>
            <div class="space-y-5">
                <input type="text" id="inputBucketItem" placeholder="e.g. Visit Paris..." class="w-full bg-white/50 border border-white/60 rounded-xl px-4 py-3 text-sm outline-none focus:bg-white/80 transition-colors">
                <button onclick="window.confirmAddBucket()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl hover:bg-slate-700 shadow-lg active:scale-95 transition-all">Add to List</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDSzJ122FALo6tHNU4gpsUQkGujDf_AcQk",
          authDomain: "love-megha.firebaseapp.com",
          projectId: "love-megha",
          storageBucket: "love-megha.firebasestorage.app",
          messagingSenderId: "99278137805",
          appId: "1:99278137805:web:895a407a9dfcc535687c84",
          measurementId: "G-JSLRXLGRCY"
        };

        let db, auth;
        const DOC_ID = "us_data";
        let currentUser = null; 
        let selectedProfileTemp = null;
        let isFirebaseInitialized = false;

        const USERS = {
            'Megha': { 
                id: 1, 
                partner: 'Sahariar', 
                pass: 'sahariar',
                gradient: 'from-pink-400 to-rose-500'
            },
            'Sahariar': { 
                id: 2, 
                partner: 'Megha', 
                pass: 'megha',
                gradient: 'from-blue-400 to-indigo-500'
            }
        };

        const moods = [
            { id: 'happy', label: 'Happy', icon: 'üòä' },
            { id: 'sad', label: 'Sad', icon: 'ü•∫' },
            { id: 'loved', label: 'Loved', icon: 'ü•∞' },
            { id: 'excited', label: 'Excited', icon: 'ü§©' },
            { id: 'tired', label: 'Tired', icon: 'üò¥' },
            { id: 'sleepy', label: 'Sleepy', icon: 'üí§' },
            { id: 'hungry', label: 'Hungry', icon: 'üçî' },
            { id: 'bored', label: 'Bored', icon: 'üòê' },
            { id: 'stressed', label: 'Stressed', icon: 'üò´' },
            { id: 'confused', label: 'Confused', icon: 'üòï' },
            { id: 'proud', label: 'Proud', icon: 'üòé' },
            { id: 'sick', label: 'Sick', icon: 'ü§í' },
            { id: 'horny', label: 'Naughty', icon: 'üòà' },
            { id: 'praying', label: 'Praying', icon: 'ü§≤' },
            { id: 'studying', label: 'Studying', icon: 'üìö' },
            { id: 'busy', label: 'Working', icon: 'üíº' },
        ];

        let appData = {
            name1: "Megha", name2: "Sahariar",
            offset: 0, anniversary: "2025-11-10", nextMeet: "",
            mood1: 'happy', mood2: 'happy',
            note1: "", note2: "",
            lastActive1: 0, lastActive2: 0,
            status1: 'resting', status2: 'resting',
            bucketList: []
        };

        function init() {
            const dd = document.getElementById('myMoodDropdown');
            dd.innerHTML = moods.map(m => `
                <button onclick="window.selectMyMood('${m.id}')" class="w-full text-left px-5 py-3.5 hover:bg-white/50 flex items-center gap-3 transition-colors border-b border-white/20 last:border-0 active:bg-white/80">
                    <span class="text-2xl">${m.icon}</span>
                    <span class="text-sm font-bold text-slate-700">${m.label}</span>
                </button>
            `).join('');

            loadLocal();
            
            const savedUser = localStorage.getItem('ldr_user');
            if (savedUser && USERS[savedUser]) {
                currentUser = savedUser;
                document.getElementById('loadingScreen').classList.remove('hidden');
                initFirebase();
            } else {
                showLoginScreen();
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 500); 
            }
        }

        function initFirebase() {
            if (isFirebaseInitialized) return;
            if (!firebaseConfig.apiKey) {
                enterApp(); return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;

                signInAnonymously(auth).catch(console.error);
                onAuthStateChanged(auth, user => {
                    const el = document.getElementById('syncStatus');
                    if(user) {
                        el.className = "w-2.5 h-2.5 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]";
                        setupListener();
                    } else {
                        el.className = "w-2.5 h-2.5 rounded-full bg-red-400";
                    }
                });
                setTimeout(enterApp, 3000); 
            } catch (e) { console.error(e); enterApp(); }
        }

        function setupListener() {
            onSnapshot(doc(db, "couples", DOC_ID), (snap) => {
                if (snap.exists()) {
                    appData = { ...appData, ...snap.data() };
                    renderDashboard();
                    if (currentUser && document.getElementById('mainContent').classList.contains('hidden')) {
                        enterApp();
                    }
                } else {
                    setDoc(doc(db, "couples", DOC_ID), appData);
                    enterApp();
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // --- GLOBAL FUNCTIONS (WINDOW) ---

        window.selectProfile = (name) => {
            selectedProfileTemp = name;
            document.getElementById('profileSelection').classList.add('hidden');
            document.getElementById('passwordSection').classList.remove('hidden');
            setTimeout(() => document.getElementById('loginPassword').focus(), 100);
        };

        window.backToProfiles = () => {
            selectedProfileTemp = null;
            document.getElementById('passwordSection').classList.add('hidden');
            document.getElementById('profileSelection').classList.remove('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginPassword').value = '';
        };

        window.togglePasswordVisibility = () => {
            const input = document.getElementById('loginPassword');
            const icon = document.getElementById('passwordIcon');
            if(input.type === "password"){
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        };

        window.attemptLogin = () => {
            const input = document.getElementById('loginPassword').value;
            if (input === USERS[selectedProfileTemp].pass) {
                currentUser = selectedProfileTemp;
                if (document.getElementById('rememberMe').checked) {
                    localStorage.setItem('ldr_user', currentUser);
                }
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('loadingScreen').classList.remove('opacity-0');
                initFirebase();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        window.logout = () => {
            localStorage.removeItem('ldr_user');
            location.reload();
        };

        function enterApp() {
            if (!document.getElementById('mainContent').classList.contains('hidden')) return;
            const loader = document.getElementById('loadingScreen');
            loader.classList.add('opacity-0');
            document.getElementById('mainContent').classList.remove('hidden');
            setTimeout(() => loader.classList.add('hidden'), 300);
            renderDashboard();
        }

        function renderDashboard() {
            if(!currentUser) return;

            const myId = USERS[currentUser].id;
            const partnerName = USERS[currentUser].partner;
            const partnerId = USERS[partnerName].id;

            // Header
            document.getElementById('headerProfileName').innerText = currentUser;

            // Partner Section
            renderBubble(partnerId, 'partner', partnerName);
            // My Section
            renderBubble(myId, 'my', currentUser);

            // Controls
            const myStatus = appData[`status${myId}`];
            const myMood = appData[`mood${myId}`];
            const myNote = appData[`note${myId}`];

            document.getElementById('myStatusToggle').checked = (myStatus === 'working');
            
            const myMoodObj = moods.find(m => m.id === myMood) || moods[0];
            document.getElementById('myControlMoodIcon').innerText = myMoodObj.icon;
            document.getElementById('myControlMoodLabel').innerText = myMoodObj.label;

            const noteInput = document.getElementById('myNoteInput');
            if (!isEditingNote && noteInput.value !== myNote) {
                noteInput.value = myNote || "";
            }

            renderBucketList();
            updateTimers();
        }

        function renderBubble(userId, prefix, name) {
            const mood = appData[`mood${userId}`];
            const status = appData[`status${userId}`];
            const note = appData[`note${userId}`];
            const lastActive = appData[`lastActive${userId}`];

            const avatarBg = document.getElementById(`${prefix}AvatarBg`);
            const statusDot = document.getElementById(`${prefix}StatusDot`);
            const moodBadge = document.getElementById(`${prefix}MoodBadge`);
            const workBadge = document.getElementById(`${prefix}WorkBadge`);

            const isMegha = (name === 'Megha');
            const grad = isMegha ? 'from-pink-400 to-rose-500' : 'from-blue-400 to-indigo-500';
            avatarBg.className = `w-24 h-24 rounded-full flex items-center justify-center text-3xl shadow-xl border-4 border-white/80 relative z-10 transition-transform duration-500 group-hover:scale-105 backdrop-blur-md bg-gradient-to-br ${grad} text-white`;

            const moodObj = moods.find(m => m.id === mood) || moods[0];
            moodBadge.innerText = moodObj.icon;
            document.getElementById(`${prefix}NameDisplay`).innerText = name === currentUser ? "Me" : name;
            
            if (prefix === 'my') {
                 document.getElementById('myNoteDisplay').innerText = note || "Tap 'Update' to add a note...";
            } else {
                 document.getElementById('partnerNoteText').innerText = note || "No thoughts yet...";
                 document.getElementById('partnerLastActive').innerText = timeAgo(lastActive);
            }

            if(status === 'working') {
                statusDot.className = "absolute bottom-1 right-1 w-6 h-6 rounded-full border-4 border-white/80 z-20 shadow-md bg-orange-500";
                workBadge.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase shadow-sm bg-orange-100 text-orange-600";
                workBadge.innerHTML = `<i class="fas fa-briefcase"></i> Working`;
            } else {
                statusDot.className = "absolute bottom-1 right-1 w-6 h-6 rounded-full border-4 border-white/80 z-20 shadow-md bg-green-500";
                workBadge.className = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase shadow-sm bg-green-100 text-green-600";
                workBadge.innerHTML = `<i class="fas fa-coffee"></i> Resting`;
            }
        }

        function timeAgo(timestamp) {
            if(!timestamp) return '';
            const diff = Math.floor((Date.now() - timestamp) / 1000);
            if (diff < 60) return 'Just now';
            const m = Math.floor(diff / 60);
            if (m < 60) return `${m}m ago`;
            const h = Math.floor(m / 60);
            if (h < 24) return `${h}h ago`;
            const d = Math.floor(h / 24);
            return `${d}d ago`;
        }

        function showSaveFeedback() {
            const status = document.getElementById('mySaveStatus');
            status.innerText = "SAVED";
            status.className = "text-[9px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full transition-opacity";
            status.style.opacity = '1';
            setTimeout(() => status.style.opacity = '0', 1500);
        }

        function updateActivity() {
            const myId = USERS[currentUser].id;
            appData[`lastActive${myId}`] = Date.now();
        }

        // Window exposed functions
        window.toggleMyControls = () => {
            const panel = document.getElementById('myControlsPanel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                panel.classList.add('animate-slide-down');
            } else {
                panel.classList.add('hidden');
                panel.classList.remove('animate-slide-down');
            }
        };

        window.updateMyStatus = () => {
            const myId = USERS[currentUser].id;
            const isWorking = document.getElementById('myStatusToggle').checked;
            appData[`status${myId}`] = isWorking ? 'working' : 'resting';
            updateActivity();
            saveData();
            showSaveFeedback();
            renderDashboard(); 
        };

        window.toggleMyMoodDropdown = () => {
            document.getElementById('myMoodDropdown').classList.toggle('hidden');
        };

        window.selectMyMood = (id) => {
            const myId = USERS[currentUser].id;
            appData[`mood${myId}`] = id;
            updateActivity();
            saveData();
            document.getElementById('myMoodDropdown').classList.add('hidden');
            showSaveFeedback(); 
            renderDashboard(); 
        };

        let isEditingNote = false;
        window.toggleNoteEdit = () => {
            const input = document.getElementById('myNoteInput');
            const icon = document.getElementById('noteEditIcon');
            const myId = USERS[currentUser].id;

            if (!isEditingNote) {
                isEditingNote = true;
                input.removeAttribute('readonly');
                input.classList.remove('opacity-70');
                input.focus();
                icon.classList.remove('fa-pen');
                icon.classList.add('fa-check');
            } else {
                isEditingNote = false;
                input.setAttribute('readonly', true);
                input.classList.add('opacity-70');
                icon.classList.remove('fa-check');
                icon.classList.add('fa-pen');
                
                appData[`note${myId}`] = input.value;
                updateActivity();
                saveData();
                showSaveFeedback();
                renderDashboard(); 
            }
        };

        function renderBucketList() {
            const list = document.getElementById('bucketList');
            if(appData.bucketList.length === 0) {
                list.innerHTML = `<li class="text-center text-slate-500 text-xs italic py-2">Add your first goal...</li>`;
                return;
            }
            list.innerHTML = appData.bucketList.map(item => {
                let dotColor = 'border-slate-300';
                let checkColor = 'bg-slate-400';
                if(item.addedBy === 1) { 
                    dotColor = 'border-pink-400';
                    checkColor = 'bg-pink-500';
                } else if(item.addedBy === 2) { 
                    dotColor = 'border-blue-400';
                    checkColor = 'bg-blue-500';
                }

                return `
                <li class="flex items-center justify-between p-3 rounded-2xl bg-white/40 border border-white/50 backdrop-blur-sm transition-all hover:bg-white/60">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="window.toggleBucketItem(${item.id})">
                        <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${item.done ? checkColor + ' border-transparent' : dotColor}">
                            ${item.done ? '<i class="fas fa-check text-white text-[9px]"></i>' : ''}
                        </div>
                        <span class="text-sm font-bold text-slate-700 ${item.done ? 'line-through opacity-50' : ''}">${item.text}</span>
                    </div>
                    <button onclick="window.deleteBucketItem(${item.id})" class="text-slate-400 hover:text-red-500 transition-colors p-2"><i class="fas fa-trash text-xs"></i></button>
                </li>
            `}).join('');
        }

        function updateTimers() {
            const now = new Date();
            
            const timeOptions = {hour:'2-digit', minute:'2-digit', second: '2-digit'};
            document.getElementById('partnerTimeDisplay').innerText = now.toLocaleTimeString([], timeOptions);

            let togetherText = { d:0, h:0, m:0, s:0 };
            if (appData.anniversary) {
                const start = new Date(appData.anniversary);
                const diff = now - start;
                togetherText.d = Math.floor(diff / 86400000);
                togetherText.h = Math.floor((diff % 86400000) / 3600000);
                togetherText.m = Math.floor((diff % 3600000) / 60000);
                togetherText.s = Math.floor((diff % 60000) / 1000);
            }

            const loginContainer = document.getElementById('loginCountdownContainer');
            if (loginContainer) {
                const block = (v, l) => `
                    <div class="flex flex-col items-center w-12 bg-white/40 rounded-xl py-1.5 border border-white/50 backdrop-blur-sm">
                        <span class="text-xl font-bold text-slate-800 font-mono">${String(v).padStart(2,'0')}</span>
                        <span class="text-[8px] font-bold text-slate-500 uppercase">${l}</span>
                    </div>`;
                loginContainer.innerHTML = block(togetherText.d,'D') + block(togetherText.h,'H') + block(togetherText.m,'M') + block(togetherText.s,'S');
            }

            const togetherEl = document.getElementById('togetherTimer');
            if(togetherEl) togetherEl.innerText = `${togetherText.d}d ${togetherText.h}h ${togetherText.m}m ${togetherText.s}s together ‚ù§Ô∏è`;

            const dashContainer = document.getElementById('countdownContainer');
            if(dashContainer) {
                if(appData.nextMeet) {
                    const target = new Date(appData.nextMeet);
                    const diff = target - now;
                    if(diff < 0) {
                        dashContainer.innerHTML = `<span class="text-pink-500 font-bold animate-pulse text-sm font-script text-2xl">Together at last! ‚ù§Ô∏è</span>`;
                    } else {
                        const d = Math.floor(diff / 86400000);
                        const h = Math.floor((diff % 86400000) / 3600000);
                        const m = Math.floor((diff % 3600000) / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        
                        const block = (v, l) => `
                            <div class="flex flex-col items-center w-12 bg-white/40 rounded-xl py-2 border border-white/50 backdrop-blur-sm shadow-sm">
                                <span class="text-xl font-bold text-slate-800 font-mono">${String(v).padStart(2,'0')}</span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase tracking-wider">${l}</span>
                            </div>`;
                        dashContainer.innerHTML = block(d,'D') + block(h,'H') + block(m,'M') + block(s,'S');
                        
                        const dateText = document.getElementById('nextMeetDateDisplay');
                        if(dateText) dateText.innerText = `Until ${target.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'})}`;
                    }
                } else {
                    dashContainer.innerHTML = `<span class="text-xs text-slate-500 italic bg-white/30 px-4 py-2 rounded-full">Tap settings to set date</span>`;
                    const dateText = document.getElementById('nextMeetDateDisplay');
                    if(dateText) dateText.innerText = "Waiting...";
                }
            }
        }

        // --- EXPOSED MODALS ---
        window.openSettingsModal = () => {
            document.getElementById('inputNextMeet').value = appData.nextMeet;
            document.getElementById('settingsModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('settingsPanel').classList.remove('scale-95', 'opacity-0');
                document.getElementById('settingsPanel').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        window.closeSettingsModal = () => {
            document.getElementById('settingsPanel').classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 200);
        }
        window.saveSettings = () => {
            appData.nextMeet = document.getElementById('inputNextMeet').value;
            saveData();
            window.closeSettingsModal();
        }

        window.openBucketModal = () => {
            document.getElementById('inputBucketItem').value = '';
            document.getElementById('bucketModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('bucketPanel').classList.remove('scale-95', 'opacity-0');
                document.getElementById('bucketPanel').classList.add('scale-100', 'opacity-100');
                document.getElementById('inputBucketItem').focus();
            }, 10);
        }
        window.closeBucketModal = () => {
            document.getElementById('bucketPanel').classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('bucketModal').classList.add('hidden'), 200);
        }
        window.confirmAddBucket = () => {
            const txt = document.getElementById('inputBucketItem').value;
            if(txt) {
                appData.bucketList.push({ 
                    id: Date.now(), 
                    text: txt, 
                    done: false, 
                    addedBy: USERS[currentUser].id 
                });
                saveData();
                renderBucketList();
                window.closeBucketModal();
            }
        }
        window.toggleBucketItem = (id) => {
            const i = appData.bucketList.find(x => x.id === id);
            if(i) { i.done = !i.done; saveData(); renderBucketList(); }
        }
        window.deleteBucketItem = (id) => {
            appData.bucketList = appData.bucketList.filter(x => x.id !== id);
            saveData(); renderBucketList();
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#myMoodTrigger')) {
                document.getElementById('myMoodDropdown').classList.add('hidden');
            }
        });

        function loadLocal() {
            const saved = localStorage.getItem('ldr_v4');
            if (saved) appData = { ...appData, ...JSON.parse(saved) };
            updateTimers(); 
        }
        async function saveData() {
            localStorage.setItem('ldr_v4', JSON.stringify(appData));
            if (db && auth && auth.currentUser) {
                await updateDoc(doc(db, "couples", DOC_ID), appData);
            }
        }

        init();
        setInterval(updateTimers, 1000);

    </script>
</body>
</html>


